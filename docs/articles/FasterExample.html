<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Faster Example â€¢ nQuack</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Faster Example">
<meta name="description" content="How do you apply this method to real samples efficiently?
">
<meta property="og:description" content="How do you apply this method to real samples efficiently?
">
<!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-YWYQ5CX5NC"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-YWYQ5CX5NC');
</script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">nQuack</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.2</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/BasicExample.html">Basic Example</a></li>
    <li><a class="dropdown-item" href="../articles/DataPreparation.html">Data Preparation</a></li>
    <li><a class="dropdown-item" href="../articles/FasterExample.html">Faster Example</a></li>
    <li><a class="dropdown-item" href="../articles/ModelOptions.html">Model Options</a></li>
    <li><a class="dropdown-item" href="../articles/SimulateData.html">Simulate Data</a></li>
    <li><a class="dropdown-item" href="../articles/Outliers.html">Outliers</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/mgaynor1/nQuack/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Faster Example</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mgaynor1/nQuack/blob/HEAD/vignettes/FasterExample.Rmd" class="external-link"><code>vignettes/FasterExample.Rmd</code></a></small>
      <div class="d-none name"><code>FasterExample.Rmd</code></div>
    </div>

    
    
<p>Here we provide an extension to the <a href="https://mlgaynor.com/nQuack/articles/BasicExample.html" class="external-link">example to
show you how to apply this method on real samples</a>, but expand the
tutorial to show ways to speed up your runs. Please start with the <a href="https://mlgaynor.com/nQuack/articles/BasicExample.html" class="external-link">Basic
Example</a>.</p>
<p>Time is not reported here. Not all functions in this package are able
to use multiple CPUs, however we note when functions are able to use
multiple cores.</p>
<p>To efficiently use this package, you should split your runs into at
least two parts:</p>
<ul>
<li>Data preparation.<br>
</li>
<li>Model inference.</li>
</ul>
<div class="section level2">
<h2 id="part-1-data-preparation">Part 1: Data preparation<a class="anchor" aria-label="anchor" href="#part-1-data-preparation"></a>
</h2>
<p>These functions are not set up to use multiple CPUs. Therefore, we
are using a foreach loop to speed up processing.</p>
<div class="section level3">
<h3 id="load-packages">Load packages<a class="anchor" aria-label="anchor" href="#load-packages"></a>
</h3>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://mlgaynor.com/nQuack/">nQuack</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RevolutionAnalytics/foreach" class="external-link">foreach</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RevolutionAnalytics/doparallel" class="external-link">doParallel</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="set-up-parallel">Set up parallel<a class="anchor" aria-label="anchor" href="#set-up-parallel"></a>
</h3>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># IF USING SLURM</span></span>
<span><span class="va">n.cpus</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"SLURM_CPUS_PER_TASK"</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="co"># IF NOT USING SLURM</span></span>
<span><span class="co">#n.cpus &lt;- 10</span></span>
<span></span>
<span><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">makeCluster</a></span><span class="op">(</span><span class="va">n.cpus</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/doParallel/man/registerDoParallel.html" class="external-link">registerDoParallel</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="prepare-data">01. Prepare data<a class="anchor" aria-label="anchor" href="#prepare-data"></a>
</h3>
<p>Thanks to Alyssa Phillips for requesting the <code>tempfolder</code>
option! Note, storage requirements to run this function are large due to
temporary files.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="co"># Set in and out paths of files</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>inpath <span class="ot">&lt;-</span> <span class="st">"../inst/extdata/01_raw/"</span></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a>outpath <span class="ot">&lt;-</span> <span class="st">"../inst/extdata/02_prepared/"</span></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a><span class="co"># List files in the inpath and remove their ending</span></span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a>filelist <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="at">path =</span> inpath, <span class="at">pattern =</span> <span class="st">"*.bam"</span> )</span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a>filelist <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">".bam"</span>, <span class="st">""</span>, filelist)</span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a>foreach<span class="sc">::</span><span class="fu">foreach</span>(<span class="at">iter =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(filelist)), .packages <span class="ot">=</span> <span class="st">"nQuack"</span><span class="er">)</span><span class="sc">%dopar%</span>{</span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a>    <span class="co"># Make table</span></span>
<span id="cb3-11"><a href="#cb3-11" tabindex="-1"></a>    <span class="fu">prepare_data</span>(filelist[iter], </span>
<span id="cb3-12"><a href="#cb3-12" tabindex="-1"></a>                 inpath, </span>
<span id="cb3-13"><a href="#cb3-13" tabindex="-1"></a>                 outpath, </span>
<span id="cb3-14"><a href="#cb3-14" tabindex="-1"></a>                 <span class="at">tempfolder =</span> <span class="fu">paste0</span>(<span class="st">"tmp_"</span>, iter)) </span>
<span id="cb3-15"><a href="#cb3-15" tabindex="-1"></a>                 <span class="co"># Note, you need the tempfolder name </span></span>
<span id="cb3-16"><a href="#cb3-16" tabindex="-1"></a>                 <span class="co"># to be unique to not overwrite each other</span></span>
<span id="cb3-17"><a href="#cb3-17" tabindex="-1"></a> }</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="process-data-">02. Process data.<a class="anchor" aria-label="anchor" href="#process-data-"></a>
</h3>
<p>Next up, we filter the data file.</p>
<p>Here we are following the filtering approach found in nQuire: a
minimum depth of 10, allele trunctation minimum of 0.15, and allele
truncation maximum of 0.85.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>inpathtext <span class="ot">&lt;-</span> <span class="st">"../inst/extdata/02_prepared/"</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>newfilelist <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="at">path =</span> inpathtext, <span class="at">pattern =</span> <span class="st">"*.txt"</span> )</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>foreach<span class="sc">::</span><span class="fu">foreach</span>(<span class="at">iter =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(newfilelist), </span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>                 <span class="at">.packages =</span> <span class="st">"nQuack"</span>)<span class="sc">%dopar%</span>{</span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a>   samp <span class="ot">&lt;-</span> newfilelist[iter]</span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a>   temp <span class="ot">&lt;-</span> <span class="fu">process_data</span>(<span class="fu">paste0</span>(inpathtext, samp), </span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a>                        <span class="at">min.depth =</span> <span class="dv">10</span>, </span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a>                        <span class="at">max.depth.quantile.prob =</span> <span class="dv">1</span>, </span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a>                        <span class="at">error =</span> <span class="fl">0.01</span>, </span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a>                        <span class="at">trunc =</span> <span class="fu">c</span>(<span class="fl">0.15</span>,<span class="fl">0.85</span>))</span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a>  </span>
<span id="cb4-13"><a href="#cb4-13" tabindex="-1"></a>  </span>
<span id="cb4-14"><a href="#cb4-14" tabindex="-1"></a>  <span class="fu">write.csv</span>(temp, </span>
<span id="cb4-15"><a href="#cb4-15" tabindex="-1"></a>              <span class="at">file =</span> <span class="fu">paste0</span>(<span class="st">"../inst/extdata/03_processed/"</span>,</span>
<span id="cb4-16"><a href="#cb4-16" tabindex="-1"></a>                            <span class="fu">gsub</span>(<span class="st">".txt"</span>, <span class="st">""</span>, samp), <span class="st">".csv"</span>)       </span>
<span id="cb4-17"><a href="#cb4-17" tabindex="-1"></a>              <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb4-18"><a href="#cb4-18" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="stop-cluster">Stop cluster<a class="anchor" aria-label="anchor" href="#stop-cluster"></a>
</h3>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">stopCluster</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="part-2-model-inference">Part 2: Model inference<a class="anchor" aria-label="anchor" href="#part-2-model-inference"></a>
</h2>
<p>This is a foreach-based function, so do <strong>NOT</strong> use a
foreach loop onto of these functions.</p>
<p>When you are using this method on an unexplored sample set, we
suggest to examine the data under at least 18 model types for all three
distributions, a total of 54 models. These functions can be run on
multiple cores.</p>
<div class="section level3">
<h3 id="slurm-example">SLURM Example<a class="anchor" aria-label="anchor" href="#slurm-example"></a>
</h3>
<p>Please set the length of the array to match the number of samples you
have. Here we are assuming 100 samples and you are running 20 samples at
once on 16 CPUs each = 320 CPUs and 500 GB of memory must be available
for you to run this.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a><span class="co">#SBATCH --job-name=02_Model</span></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a><span class="co">#SBATCH --mail-type=ALL</span></span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a><span class="co">#SBATCH --mail-user=email@address.com</span></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a><span class="co">#SBATCH --mem=25gb</span></span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a><span class="co">#SBATCH --time=4-00:00:00</span></span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a><span class="co">#SBATCH --cpus-per-task=16</span></span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a><span class="co">#SBATCH --nodes=1</span></span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a><span class="co">#SBATCH --output=../logs/out/02_Model_%A_%a.out</span></span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a><span class="co">#SBATCH --error=../logs/err/02_Model_%A_%a.err</span></span>
<span id="cb6-11"><a href="#cb6-11" tabindex="-1"></a><span class="co">#SBATCH -a 1-100%20  # Set array with throttle </span></span>
<span id="cb6-12"><a href="#cb6-12" tabindex="-1"></a></span>
<span id="cb6-13"><a href="#cb6-13" tabindex="-1"></a><span class="co"># Load modules</span></span>
<span id="cb6-14"><a href="#cb6-14" tabindex="-1"></a>module load R<span class="sc">/</span><span class="fl">4.5</span></span>
<span id="cb6-15"><a href="#cb6-15" tabindex="-1"></a></span>
<span id="cb6-16"><a href="#cb6-16" tabindex="-1"></a><span class="co"># Submit R script and pass along array</span></span>
<span id="cb6-17"><a href="#cb6-17" tabindex="-1"></a>Rscript 02_Model.R <span class="sc">$</span>SLURM_ARRAY_TASK_ID</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="model-r">02_Model.R<a class="anchor" aria-label="anchor" href="#model-r"></a>
</h3>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Load packages</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://mlgaynor.com/nQuack/">nQuack</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Set CPUs</span></span>
<span><span class="va">ncpus</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"SLURM_CPUS_PER_TASK"</span><span class="op">)</span><span class="op">)</span> </span>
<span></span>
<span><span class="co">## Read in list of samples</span></span>
<span><span class="va">samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"MLG013"</span>, <span class="st">"MLG014"</span>, <span class="st">"MLG015"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Set array value </span></span>
<span><span class="va">arrayvalue</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/commandArgs.html" class="external-link">commandArgs</a></span><span class="op">(</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Select sample</span></span>
<span><span class="va">s</span> <span class="op">&lt;-</span> <span class="va">samples</span><span class="op">[[</span><span class="va">arrayvalue</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span><span class="co">## Run models</span></span>
<span><span class="co">### Read in file</span></span>
<span><span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"../inst/extdata/03_processed/"</span>, <span class="va">s</span>, <span class="st">".csv"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## quackNormal</span></span>
<span><span class="va">out1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/quackNormal.html">quackNormal</a></span><span class="op">(</span>xm <span class="op">=</span> <span class="va">temp</span>, </span>
<span>                    samplename <span class="op">=</span> <span class="va">s</span>, </span>
<span>                    cores <span class="op">=</span> <span class="va">ncpus</span>, </span>
<span>                    parallel <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">## quackBeta</span></span>
<span><span class="va">out2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/quackBeta.html">quackBeta</a></span><span class="op">(</span>xm <span class="op">=</span> <span class="va">temp</span>, </span>
<span>                  samplename <span class="op">=</span> <span class="va">s</span>, </span>
<span>                  cores <span class="op">=</span> <span class="va">ncpus</span>, </span>
<span>                  parallel <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">### quackBetaBinom</span></span>
<span><span class="va">out3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/quackBetaBinom.html">quackBetaBinom</a></span><span class="op">(</span>xm <span class="op">=</span> <span class="va">temp</span>, </span>
<span>                       samplename <span class="op">=</span> <span class="va">s</span>, </span>
<span>                       cores <span class="op">=</span> <span class="va">ncpus</span>, </span>
<span>                       parallel <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">## Save output</span></span>
<span><span class="va">allout</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">out1</span>, <span class="va">out2</span>, <span class="va">out3</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/write.table.html" class="external-link">write.csv</a></span><span class="op">(</span><span class="va">allout</span>, </span>
<span>          file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"../inst/extdata/04_output/"</span>,</span>
<span>                          <span class="va">s</span>, <span class="st">".csv"</span><span class="op">)</span>,</span>
<span>          row.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="what-if-i-am-not-using-slurm">What if I am not using SLURM?<a class="anchor" aria-label="anchor" href="#what-if-i-am-not-using-slurm"></a>
</h3>
<p>Here is a workaround from Marne Quigg.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load packages</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://mlgaynor.com/nQuack/">nQuack</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">parallel</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Create list of samples</span></span>
<span><span class="va">samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"MLG013"</span>, <span class="st">"MLG014"</span>, <span class="st">"MLG015"</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">run_model</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">sample</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"../inst/extdata/03_processed/"</span>, </span>
<span>                                        <span class="va">sample</span>, <span class="st">".csv"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="va">out1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/quackNormal.html">quackNormal</a></span><span class="op">(</span>xm <span class="op">=</span> <span class="va">temp</span>, </span>
<span>                          samplename <span class="op">=</span> <span class="va">sample</span>, </span>
<span>                          cores <span class="op">=</span> <span class="fl">1</span>, </span>
<span>                          parallel <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>      <span class="va">out2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/quackBeta.html">quackBeta</a></span><span class="op">(</span>xm <span class="op">=</span> <span class="va">temp</span>,</span>
<span>                        samplename <span class="op">=</span> <span class="va">sample</span>, </span>
<span>                        cores <span class="op">=</span> <span class="fl">1</span>, </span>
<span>                        parallel <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>      <span class="va">out3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/quackBetaBinom.html">quackBetaBinom</a></span><span class="op">(</span>xm <span class="op">=</span> <span class="va">temp</span>, </span>
<span>                             samplename <span class="op">=</span> <span class="va">sample</span>, </span>
<span>                             cores <span class="op">=</span> <span class="fl">1</span>, </span>
<span>                             parallel <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>      </span>
<span>      <span class="va">allout</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">out1</span>, <span class="va">out2</span>, <span class="va">out3</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/utils/write.table.html" class="external-link">write.csv</a></span><span class="op">(</span><span class="va">allout</span>,</span>
<span>                file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"../inst/extdata/04_output/"</span>, </span>
<span>                          <span class="va">sample</span>, <span class="st">".csv"</span><span class="op">)</span>,</span>
<span>                row.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">## Run in parallel across samples</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/parallel/mclapply.html" class="external-link">mclapply</a></span><span class="op">(</span><span class="va">samples</span>, <span class="va">run_model</span>, mc.cores <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="wait-this-is-still-slow">Wait, this is still slow!<a class="anchor" aria-label="anchor" href="#wait-this-is-still-slow"></a>
</h3>
<p>Before you send me an email, please time your steps to help us
identify what is actually slow.</p>
<div class="section level4">
<h4 id="model_withtimers-r">02_Model_withTimers.R<a class="anchor" aria-label="anchor" href="#model_withtimers-r"></a>
</h4>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Load packages</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://mlgaynor.com/nQuack/">nQuack</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Set CPUs</span></span>
<span><span class="va">ncpus</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"SLURM_CPUS_PER_TASK"</span><span class="op">)</span><span class="op">)</span> </span>
<span></span>
<span><span class="co">## Read in list of samples</span></span>
<span><span class="va">samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"MLG013"</span>, <span class="st">"MLG014"</span>, <span class="st">"MLG015"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Set array value </span></span>
<span><span class="va">arrayvalue</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/commandArgs.html" class="external-link">commandArgs</a></span><span class="op">(</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Select sample</span></span>
<span><span class="va">s</span> <span class="op">&lt;-</span> <span class="va">samples</span><span class="op">[[</span><span class="va">arrayvalue</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span><span class="co">## Print Start Time</span></span>
<span><span class="va">starttime</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Starting time "</span>, <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">" seconds"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Run models</span></span>
<span><span class="co">### Read in file</span></span>
<span><span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"../inst/extdata/03_processed/"</span>, <span class="va">s</span>, <span class="st">".csv"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">endT</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="va">starttime</span>, unit <span class="op">=</span> <span class="st">"secs"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"temp file read into R in: "</span>, <span class="va">endT</span>, <span class="st">" seconds"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## quackNormal</span></span>
<span><span class="va">Ntime</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Starting quackNormal at "</span>, <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">" seconds"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">out1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/quackNormal.html">quackNormal</a></span><span class="op">(</span>xm <span class="op">=</span> <span class="va">temp</span>, </span>
<span>                    samplename <span class="op">=</span> <span class="va">s</span>, </span>
<span>                    cores <span class="op">=</span> <span class="va">ncpus</span>, </span>
<span>                    parallel <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">endN</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="va">Ntime</span>, unit <span class="op">=</span> <span class="st">"secs"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"quackNormal Calculated in: "</span>, <span class="va">endN</span>, <span class="st">" seconds"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## quackBeta</span></span>
<span><span class="va">Btime</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Starting quackBeta at "</span>, <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">" seconds"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">out2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/quackBeta.html">quackBeta</a></span><span class="op">(</span>xm <span class="op">=</span> <span class="va">temp</span>, </span>
<span>                  samplename <span class="op">=</span> <span class="va">s</span>, </span>
<span>                  cores <span class="op">=</span> <span class="va">ncpus</span>, </span>
<span>                  parallel <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">endB</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="va">Btime</span>, unit <span class="op">=</span> <span class="st">"secs"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"quackBeta Calculated in: "</span>, <span class="va">endN</span>, <span class="st">" seconds"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### quackBetaBinom</span></span>
<span><span class="va">BBtime</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Starting quackBetaBinom at "</span>, <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">" seconds"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">out3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/quackBetaBinom.html">quackBetaBinom</a></span><span class="op">(</span>xm <span class="op">=</span> <span class="va">temp</span>, </span>
<span>                       samplename <span class="op">=</span> <span class="va">s</span>, </span>
<span>                       cores <span class="op">=</span> <span class="va">ncpus</span>, </span>
<span>                       parallel <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">endBB</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="va">BBtime</span>, unit <span class="op">=</span> <span class="st">"secs"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"quackBetaBinom Calculated in: "</span>, <span class="va">endBB</span>, <span class="st">" seconds"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Save output</span></span>
<span><span class="va">allout</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">out1</span>, <span class="va">out2</span>, <span class="va">out3</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/write.table.html" class="external-link">write.csv</a></span><span class="op">(</span><span class="va">allout</span>, </span>
<span>          file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"../inst/extdata/04_output/"</span>,</span>
<span>                          <span class="va">s</span>, <span class="st">".csv"</span><span class="op">)</span>,</span>
<span>          row.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">endtime</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="va">starttime</span> , unit <span class="op">=</span> <span class="st">"secs"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Total calculation for sample, "</span>, <span class="va">s</span>, <span class="st">", calculated in: "</span>, <span class="va">endtime</span>, <span class="st">" seconds"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by ML Gaynor.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
